<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title></title>
</head>
<body bgcolor="#ffffff">
<div style="font-size: 24">
<hr />
<a href="k10.html"><img src="rightarrow.gif" align="right" border="0" alt="next"/></a>
<a href="k0.html"><img src="uparrow.gif" align="right" border="0" alt="content"/></a><a href="k8.html"><img src="leftarrow.gif" align="right" border="0" alt="previous"/></a><h1><a name="distroprefs__nicht___rgern_lassen_durch_l__stige_installationen">Distroprefs: Nicht ärgern lassen durch lästige Installationen</a></h1>
<p>Der größte Brocken im neuen CPAN.pm sind die Distroprefs. Ein System
zum Steuern von Installationen, die vom normalen CPAN Mantra</p>
<pre>
    perl Makefile.PL
    make
    make test
    make install</pre>
<p>beziehungsweise, für die Module::Build Hemisphäre</p>
<pre>
    perl Build.PL
    ./Build
    ./Build test
    ./Build install</pre>
<p>abweichen. Hier herrscht ja bekanntlich Anarchie, und jeder Autor, der
irgendetwas an seinem Modul konfigurierbar machen möchte, macht das
auf seine eigene Art und Weise.</p>
<p>Distroprefs machen damit Schluss, weil für praktisch alle Hindernisse,
die Autoren sich so ausgedacht haben, eine Gegenmaßnahme konfiguriert
werden kann, die von CPAN.pm wunschgemäß ausgeführt wird. CPAN.pm
setzt dann eben Environment Variable und Befehlszeilenargumente oder
Konfigurationsvariable oder es beantwortet Fragen selbsttätig.</p>
<p>Ja, wir können sogar Module automatisch lokal patchen, sofern ein
Patch lokal oder auf CPAN vorhanden ist. Oder wir können auch die
Installation von Modulen komplett verhindern.</p>
<p>Hier ist ein einfaches Beispiel einer Distribution, die normalerweise
immer sieben Fragen stellt, ob es dieses oder jenes Programm
installieren soll.</p>
<pre>
  ---
  comment: &quot;The -n asks no questions, takes default values&quot;
  match:
    distribution: &quot;^GAAS/libwww-perl-&quot;
  pl:
    args:
      - -n</pre>
<p>Die Syntax ist YAML. Es gibt einen optionalen <code>comment</code>, der in
diesem Fall erklärt, was dieses Schnippsel tut. Wir haben eine
Variable <code>match</code>, die ein Prüfkriterium festlegt, das gegen jede
get/make/test/install Aktivität abgeprüft wird. In diesem Fall geht es
um die libwww Distribution von Gisle Aas, egal welche Version. Der
Befehl an CPAN.pm ist schließlich, dass er in der <code>pl</code> Phase ein
Argument übergeben soll, nämlich <code>-n</code>.</p>
<p>Man aktiviert Distroprefs mit</p>
<pre>
  cpan&gt; o conf init prefs_dir</pre>
<p>Für nützliche Beispiele sieht man sich im <code>distroprefs/</code> Directory
der CPAN.pm Distribution um. Dort findet man auch ein Beispiel, bei
dem die Frage des Autors tatsächlich beantwortet wird:</p>
<pre>
  ---
  match:
    distribution: &quot;^LEAKIN/File-Rsync-&quot;
  make:
    expect:
      - &quot;Path to rsync &quot;
      - &quot;/usr/bin/rsync\n&quot;</pre>
<p>Man sieht hier, der Autor fragt nicht in der <code>pl</code> Phase, sondern erst
in der <code>make</code> Phase. Er fragt nach einem Pfad, den man bestätigen
oder eingeben kann. Hier muß das Modul Expect installiert sein, damit
es die Frage lesen und beantworten kann.</p>
<p>Liegt diese Distroprefs Datei erst einmal im <code>prefs_dir</code> Verzeichnis,
wird CPAN.pm immer wieder bei der Installation dieses Moduls die Frage
für uns beantworten.</p>
<p>Noch ein Beispiel: eine Environment Variable während das Tests:</p>
<pre>
  ---
  match:
    distribution: &quot;^SREZIC/Tk-Autoscroll-&quot;
  test:
    env:
      BATCH: 1</pre>
<p>Der Test dieses Moduls öffnet normalerweise ein Tk Fenster, das der
Benutzer schliessen muss, bevor es weitergeht. Durch das Setzen der
Environment Variable BATCH, wird dieser Test übersprungen.</p>
<p>Das nächste Beispiel zeigt eine großzügige Kombination mehrerer
distroprefs features:</p>
<pre>
  ---
  match:
    distribution: &quot;^AUDREYT/Module-Install-0.64&quot;
  pl:
    env:
      PERL_AUTOINSTALL: --skip
  make:
    env:
      PERL_AUTOINSTALL: --skip
  patches:
    - &quot;ANDK/patches/Module-Install-0.64-ANDK-01.patch&quot;</pre>
<p>Diese distroprefs Struktur setzt in zwei Phasen die
Environmentvariable <code>PERL_AUTOINSTALL</code> auf <code>--skip</code>. Darüber hinaus
patcht sie die Distribution. Mancher wird fragen, warum nicht den
Patch auf RT hinterlegen? Das kann man ja zusätzlich machen. Es gibt
einfach Situationen, in denen ein Autor über Monate hinweg Patches auf
RT ignoriert. Mit Distroprefs sind wir Herr der Lage: der Patch ist
öffentlich, wir können ihn vollautomatisch integrieren, wir können
einen Link darauf in RT hinterlegen, wir sind nicht auf die
unmittelbare und sofortige Kooperation durch den Autor angewiesen.</p>
<p>Das folgende Beispiel ist historisch, weil ich kein aktuelles
vergleichbares Beispiel gefunden habe:</p>
<pre>
  ---
  match:
    distribution: &quot;^CHAMAS/Crypt-SSLeay-&quot;
  goto: &quot;DLAND/Crypt-SSLeay-0.52_02.tar.gz&quot;</pre>
<p>Hier haben wir den Fall, dass sich ein neuer Autor anschickt, ein Modul
zu übernehmen, aber bevor er es tut, startet er einen Testballon. Die
Crypt::SSLeay Distribution war eine Weile, sagen wir
<em>vernachlässigt</em>. Ein anderer Maintainer war bereit, in die Bresche
zu springen. Bevor er jedoch ein eigenes Release machen konnte, wollte
er ein wenig experimentieren und einem interessierten Kreis ein paar
Developer Releases vorstellen. <code>goto</code> erlaubt eine solche Situation
zu unterstützen. Im vorliegenden Fall führte jeder
Installationsversuch für Crypt::SSLeay zur sofortigen Installation des
Developer-Releases von David Landgren.</p>
<p>Das muß nicht immer ein Autorwechsel sein, das gilt generell für
Developermodule:</p>
<pre>
  ---
  match:
    distribution: &quot;^PETDANCE/HTML-Tidy-1.06.tar.gz&quot;
  goto: &quot;PETDANCE/HTML-Tidy-1.07_01.tar.gz&quot;</pre>
<p>Andy Lester hat seit Monaten ein wunderbares HTML::Tidy 1.07_01 in
seinem Directory. Das möchte man doch immer automatisch installieren.
Distroprefs machen es möglich.</p>
<p>Für hilfreich halte ich auch die Möglichkeit, die Installation
bestimmter Module zu verhindern:</p>
<pre>
  --- 
  comment: &quot;Usually only works with current source which comes with PerlMagick anyway&quot;
  match:
    distribution: &quot;^JCRISTY/PerlMagick-&quot;
  disabled: 1</pre>
<p>Nach meiner Erfahrung kann man grade Image::Magick nie erfolgreich vom
CPAN weg installieren. Hingegen kommt mit der imagemagick Distribution
immer das richtige, funktionierende Image::Magick Perlmodul mit. Da
möchte ich verhindern, dass überhaupt jemals ein Versuch unternommen
wird, Image::Magick vom CPAN her zu installieren.</p>
<p>Ein ähnlicher Fall sind Module, die mit fallenden Versionsnummern
glänzen. Zum Beispiel war KASEI/Class-Accessor-0.25 und
KASEI/Class-Accessor-0.27 war so ein Fall. Die beiden Distributionen
enthielten wohl richtig aufsteigend die Versionsnummern 0.25 und 0.27.
Sie enthielten aber auch ein anderes Modul, das gleichzeitig eine
fallende Versionsnummer enthielt. Damit kommt CPAN.pm natürlich nicht
klar, denn bei jedem Upgrade eines der beiden Module, wird
zwangsläufig das andere downgegradet. Mit einer Distroprefs Datei kann
man das verhindern:</p>
<pre>
  ---
  comment: &quot;Since installing 0.25 after 0.27 would be a downgrade&quot;
  match:
    distribution: &quot;^KASEI/Class-Accessor-0.25&quot;
  disabled: 1</pre>
<p>Das hier kennen sicher all Anwesenden:</p>
<pre>
  Do you want to modify/update your configuration?</pre>
<p>Richtig, das kommt von der libnet Distribution. Wir schreiben immer
wieder alle brav unser <code>n</code> und RET und leiden nicht sonderlich
darunter. Außer dass wir eben nicht schlafen dürfen währen libnet
installiert wird. Also schreiben wir uns jetzt eine Distropref Datei:</p>
<pre>
  ---
  match:
    distribution: &quot;^GBARR/libnet-&quot;
  pl:
    expect:
      - &quot;Do you want to modify/update your configuration&quot;
      - &quot;n\n&quot;</pre>
<p>...und sehen die Frage nie wieder. Bis Graham sich eine neue Frage
ausdenkt.</p>
<p>Und das machen wir für WWW::Mechanize:</p>
<pre>
  --- 
  match:
    distribution: &quot;^PETDANCE/WWW-Mechanize-&quot;
  pl: 
    expect:
      - &quot;Do you want to install the mech-dump utility&quot;
      - &quot;y\n&quot;</pre>
<p>und für XML::SAX::ExpatXS</p>
<pre>
  ---
  match:
    distribution: &quot;^PCIMPRICH/XML-SAX-ExpatXS-&quot;
  pl:
    expect:
      - &quot;Do you want to alter ParserDetails.ini&quot;
      - &quot;y\n&quot;</pre>
<p>und für YAML</p>
<pre>
  ---
  match:
    distribution: &quot;^INGY/YAML-0.62&quot;
  pl:
    expect:
      - &quot;Continue installing&quot;
      - &quot;y\n&quot;</pre>
<p>und für Inline</p>
<pre>
  ---
  match:
    distribution: &quot;^INGY/Inline-&quot;
  pl:
    expect:
      - &quot;Do you want to install Inline::C&quot;
      - &quot;y\n&quot;</pre>
<p>und so weiter, und so weiter.</p>
<p>Fairerweise muß man sagen, dass das Setzen der (unterdokumentierten)
Environment Variable PERL_MM_USE_DEFAULT auch viele Fragen erledigt.
Wenn diese Variable gesetzt ist, fragen weder MakeMaker noch
Module::Build noch eine Frage, sondern nehmen immer den Defaultwert.
Das Problem ist jedoch: was tun, wenn man <em>nicht</em> den Defaultwert
will. Und zweitens: wenn der Autor überhaupt nicht die Prompt Funktion
von ExtUtils::MakeMaker oder Module::Build benutzt? Hier gelingt es
und selbst mit Distroprefs setze ich diese Variable gelegentlich:</p>
<pre>
  --- 
  comment: &quot;or just to accept defaults in future releases...&quot;
  match:
    distribution: &quot;^MLEHMANN/Coro-&quot;
  pl:
    env:
      PERL_MM_USE_DEFAULT: 1</pre>
<p>Hier gelingt es nicht:</p>
<pre>
  ---
  match:
    distribution: &quot;^ILYAZ/modules/Term-ReadLine-Perl-\d&quot;
  test:
    expect:
      - &quot;Enter arithmetic or Perl expression&quot;
      - &quot;\n&quot;</pre>
<p>Mit Distroprefs ist es egal.</p>
<p>Eine ganze Reihe von Distroprefs Dateien sind schon wieder historisch.
Etwa hat Jesse Vincent bei der Distribution von HTTP::Server::Simple
0.24 eine ungültige Signature beigelegt. In so einem Fall schreibe ich
selbstverständlich sofort einen Bugreport an RT und/oder den Autor,
aber danach schreibe ich einen Distroprefs File, der diese
Distribution von der Signatureprüfung ausnimmt:</p>
<pre>
  ---
  match:
    distribution: &quot;^JESSE/HTTP-Server-Simple-0.24\.&quot;
  cpanconfig:
    check_sigs: 0</pre>
<p>Damit ist das Problem <em>bis auf weiteres</em> für mich erschlagen, egal ob
Jesse am gleichen Tag noch eine neue Distribution rausbringt oder erst
in einem Jahr.</p>
<p>Eine schöne Kombination ist erst vor wenigen Tagen entstanden, als
Steffen Schwigon Class::MethodMaker 2.09 releaset hat:</p>
<pre>
  ---
  match:
    distribution: &quot;SCHWIGON/class-methodmaker/Class-MethodMaker-2.09.tar.gz&quot;
  cpanconfig:
    prefer_installer: &quot;EUMM&quot;
  test:
    args:
      - TEST_FILES=&quot;t/v1_boolean.t t/v1_static_list.t t/v1_key_with_cre...</pre>
<p>Ich habe hier die letzte Zeile abgeschnitten, die war mir zu lang. Als
Hintergrundinformation ist zu sagen, MethodMaker kommt sowohl mit
einem Build.PL als auch einem Makefile.PL, man hat also Wahlfreiheit,
ob man lieber Module::Build oder ExtUtils::MakeMaker benutzen möchte
(``MB''oder ``EUMM'') . Da es einen harmlosen Testfehler gab, wollte ich
lieber MakeMaker verwenden, weil der die Option <code>TEST_FILES</code> kennt,
mit der man die Tests selbst bestimmen kann, die durchlaufen sollen.
Also leiten wir das Module erst einmal auf die MakeMaker-Schiene um
und sagen ihm dann in der Testphase an, was genau er tun soll. Damit
bekommen wir ein installierbares Modul, ohne den Autor unter Druck
setzen zu müssen, der als Verleger des Tagungsbandes sowieso schon
voll ausgelastet ist. Danke, Steffen!</p>
<p>Mit den circa 100 Distroprefs Dateien, die der CPAN.pm Distribution
beigelegt sind, baue ich nun seit einigen Wochen regelmäßig
vollautomatisch und unbeaufsichtigt ca. 480 Distributionen mit ca.
3000 Modulen in einer Endlosschleife mit dem jeweils aktuellen
Bleadperl. Das dauert jeweils so um die 3-4 Stunden.</p>
<p>Ich kann nur alle ermutigen, sich solche Distroprefs Dateien
anzulegen. Die Lernkurve ist im Grunde nicht steil, für die meisten
Fälle gibt es schon ein Beispiel, das man nur abwandeln muß.
Syntaxfehler sind nicht das große Problem: wenn man <code>Kwalify</code> von
Slaven Rezi? installiert hat, werden alle lokalen Distroprefs Dateien
entsprechend geprüft und ein Fehler so diagnostiziert, daß man schnell
die richtige Lösung findet.</p>
<p>
</p>
<hr />
</div></body></html>
<!--
 Local Variables:
 mode: nxml
 coding: utf-8
 End:
-->

